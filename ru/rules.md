# Правила

В контексте расширения, `правило` представляет собой JavaScript и/или CSS код, который задействуется на веб-страницах, соответствующих его URL паттернам.

## URL паттерны

- Паттерн смеет схему: `<scheme>://<host>/<path>`;
- Можно комбинировать через запятую: `https://one.ru/*, https://two.ru/*`;
- Через `!` помечается исключающий паттерн: `!https://excluded.com/*`.

### Изменения с версии 3.0

Начиная с версии 3.0 возвросли требования к URL паттернам расширения, подробно о них можно почитать на [странице Google](https://developer.chrome.com/docs/extensions/develop/concepts/match-patterns). Если коротко:

1. Паттерн должен начинаться строго со схемы `http|https|*`;
2. Домен и зону нужно писать без масок: `one.ru`, но поддомен можно `*.one.ru`. Так же разрешается весь хост указать маской `*`.
3. Вне зависимости от наличия пути, хост завершается разделителем `/`: `https://one.ru/, https://two.ru/path*`;
4. Путь опционален, маска `*` разрешается.

**✅ Примеры рабочих паттернов:**

```
https://domain.zone/path/*
https://*.site.com/path
https://*/path/
*://*/*
```

**❌ Работать не будут:**

```
https://domain.*/*
http*://domain.zone/
https://domain.zone
domain.zone
```

::: tip Будущие измененения
Большинство невалидных паттернов сейчас работают за счёт временного преобразователя URL, но корректнеость его работы не гарантирована, поэтому рекомендуется его отключать и переписывать URL по новым правилам. В дальнейшем результат его работы будет сохранён как исходный, а сам он убран.
:::

## Свойства правил

### Маркер "общее правило"

"Общие правила" позволяют выстраивать зависимости между разными правилами и явно контролировать очерёдность их загрузки. Любое правило можно отметить как "общее" — это добавит его в список подключаемых модулей у остальных правил. Из подключаемых правил берётся только JS и CSS контент, остальные свойства подключаемого правила игнорируются.

### Свойства JavaScript

- `Изолированная среда`: если включена, то JS код запускается в изолированной среде, где JS контекст страницы недоступен, но доступен DOM.
- `Все фреймы`: если включена, код будет внедряться во все фреймы. Каждый фрейм проверяется на соответствие изначальным URL отдельно.
- `Запускать на старте`: Если включено, то скрипт внедряется до построения DOM, иначе после, но до загрузки ресурсов, таких как изображения и фреймы. Обратите внимание, что событие `DOMContentLoaded` в этом случае уже срабатывать не будет.

### Свойства CSS

- `Программное подключение`:
  - **Включено**: изначально низкий приоритет стилей, но максимальный при использовании `!important`. Доступен режим живого редактирования CSS. Можно использовать без "режима разработчика".
  - **Выключено**: более высокий приоритет стилей за счёт расположения `<style/>` в конце DOM. Недоступны режимы: живое редактирование CSS, "все фреймы". Этот режим недоступен без "режима разработчика".
- `Все фреймы`: должен ли CSS внедряться во все фреймы в пределах вкладки.
- `Автоматический !important`: добавляет `!important` ко всем свойствам CSS в уже скомпилированный код.

### Другие особенности

- Маркер правила `включено` игнорируется в случае когда правило общее и подключается другим правилом;
- Маркер `сохранять в облако` лишь указывает на включение правила в хранилище при синхронизации и не производит дополнительных действий;
- Выбор синтаксиса препроцессора `SASS` или `SCSS` происходит автоматически, на основе наличия символов в `{;}` в коде.

## ES6 Модули

Между правилами нельзя импортировать и экспортировать ES6 модули, но можно использовать модули из интернета, например таким образом:

```js
;(async () => {
  const { module } = await import("https://...")
  // ваш код здесь
})()
```
